#!/usr/bin/env bash

set -e
set -o errexit
set -o nounset

usage() {
  printf "CI Test Container\n"

  printf "Usage: bin/ci/test "
  printf -- "-c <container name> "
  printf -- "[-e <env>] "
  printf -- "[-h] "
  printf -- "[-v] "
  printf "\n"

  printf "  -%s\t%s - %s%s\n" "h" "help" "Show this help message." ""
  printf "  -%s\t%s - %s%s\n" "v" "version" "Show version information." ""
  printf "  -%s\t%s - %s%s\n" "e" "env" "Environment" " (default: dev)"
  printf "  -%s\t%s - %s%s\n" "c" "container" "Container name" ""
}

version() {
  printf "0.0.1\n"
}

# default values
opt_help="false"
opt_version="false"
opt_env="development"
opt_container=""

# declared functions

# option parsing
OPTSPEC=:hve:c:mip
while getopts $OPTSPEC option; do
  case "$option" in
    h ) opt_help="true"; usage; exit 0  ;;
    v ) opt_version="true"; version; exit 0  ;;
    e ) opt_env=$OPTARG;  ;;
    c ) opt_container=$OPTARG;  ;;
   \? ) echo "Unknown option: -$OPTARG" >&2; exit 1;;
    : ) echo "Missing option argument for -$OPTARG" >&2; exit 1;;
    * ) echo "Unimplemented option: -$OPTARG" >&2; exit 1;;
  esac
done
shift $((OPTIND - 1))

# required option validation
if [ -z "$opt_env" ] ; then
  usage
  exit 1
fi
if [ -z "$opt_container" ] ; then
  usage
  exit 1
fi

docker container prune -f
docker run -d --publish=4000:4000 --name=$opt_container zcodeapp/ide-server

DOCKER_HOSTNAME=$(bin/docker/hostname -c $opt_container)

echo -e "DOCKER_HOSTNAME";
echo -e $DOCKER_HOSTNAME
echo -e "-----------";

if [ -z $DOCKER_HOSTNAME ]; then
  echo "docker hostname empty"
  exit 1
fi

bin/docker/node/online.js $DOCKER_HOSTNAME

docker stop $opt_container;

exit 0